<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>SQLAlchemy 0.5 Documentation - Object Relational Tutorial</title>
	
    <link rel="stylesheet" href="style.css"></link>
    <link rel="stylesheet" href="docs.css"></link>
    <link href="syntaxhighlight.css" rel="stylesheet" type="text/css"></link>
    <script src="scripts.js"></script>



</head>
<body>








<div id="topanchor"><a name="top">&nbsp;</a></div>


<h1>SQLAlchemy 0.5 Documentation</h1>

<div id="pagecontrol"><a href="index.html">Multiple Pages</a> | <a href="documentation.html">One Page</a></div>

<div class="versionheader">
  Version: <span class="versionnum">0.5.0rc4</span>
  Last Updated: 11/14/08 16:38:11
</div>







<A name=""></a>


    <div class="topnav">

    
    <div class="navbanner">
        <a href="index.html" class="totoc">Table of Contents</a>
        
    <div class="prevnext">

            
            Previous: <a href="intro.html">Overview / Installation</a>

               |   
            Next: <a href="sqlexpression.html">SQL Expression Language Tutorial</a>
    </div>

        <h2>Object Relational Tutorial</h2>
    </div>

	
	
    <ul>
        
        <li><a style="" href="ormtutorial.html#datamapping_version">Version Check</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_connecting">Connecting</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_tables">Define and Create a Table</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_mapping">Define a Python Class to be Mapped</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_setting">Setting up the Mapping</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_declarative">Creating Table, Class and Mapper All at Once Declaratively</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_creating">Creating a Session</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_adding">Adding new Objects</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_rolling">Rolling Back</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_querying">Querying</a></li>

	        <li>
                
    <ul>
        
        <li><a style="" href="ormtutorial.html#datamapping_querying_common">Common Filter Operators</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_querying_scalars">Returning Lists and Scalars</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_querying_using">Using Literal SQL</a></li>

    </ul>

	        </li>
        
        <li><a style="" href="ormtutorial.html#datamapping_relation">Building a Relation</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_related_objects">Working with Related Objects</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_joins">Querying with Joins</a></li>

	        <li>
                
    <ul>
        
        <li><a style="" href="ormtutorial.html#datamapping_joins_aliases">Using Aliases</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_joins_subqueries">Using Subqueries</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_joins_using">Using EXISTS</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_joins_relationop">Common Relation Operators</a></li>

    </ul>

	        </li>
        
        <li><a style="" href="ormtutorial.html#datamapping_deleting">Deleting</a></li>

	        <li>
                
    <ul>
        
        <li><a style="" href="ormtutorial.html#datamapping_deleting_cascade">Configuring delete/delete-orphan Cascade</a></li>

    </ul>

	        </li>
        
        <li><a style="" href="ormtutorial.html#datamapping_manytomany">Building a Many To Many Relation</a></li>

        
        <li><a style="" href="ormtutorial.html#datamapping_further">Further Reference</a></li>

    </ul>

	</div>











    
    <A name="datamapping"></a>
    
    <div class="sectionL1">

    
    

<p>In this tutorial we will cover a basic SQLAlchemy object-relational mapping scenario, where we store and retrieve Python objects from a database representation.  The tutorial is in doctest format, meaning each <code>&gt;&gt;&gt;</code> line represents something you can type at a Python command prompt, and the following text represents the expected return value.
</p>


    
    <A name="datamapping_version"></a>
    
    <div class="sectionL2">

    <h3>Version Check</h3>
    
    

<p>A quick check to verify that we are on at least <strong>version 0.5</strong> of SQLAlchemy:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">import </span><span class="python_name">sqlalchemy</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">__version__ </span><span class="python_operator">
</span><span class="python_number">0.5.0</span><span class="python_operator">
</span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_connecting"></a>
    
    <div class="sectionL2">

    <h3>Connecting</h3>
    
    

<p>For this tutorial we will use an in-memory-only SQLite database.  To connect we use <code>create_engine()</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_name">create_engine</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">engine </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///:memory:'</span><span class="python_operator">, </span><span class="python_name">echo</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>The <code>echo</code> flag is a shortcut to setting up SQLAlchemy logging, which is accomplished via Python's standard <code>logging</code> module.  With it enabled, we'll see all the generated SQL produced.  If you are working through this tutorial and want less output generated, set it to <code>False</code>.   This tutorial will format the SQL behind a popup window so it doesn't get in our way; just click the "SQL" links to see what's being generated.
</p>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_tables"></a>
    
    <div class="sectionL2">

    <h3>Define and Create a Table</h3>
    
    

<p>Next we want to tell SQLAlchemy about our tables.  We will start with just a single table called <code>users</code>, which will store records for the end-users using our application (lets assume it's a website).  We define our tables within a catalog called <code>MetaData</code>, using the <code>Table</code> construct, which is used in a manner similar to SQL's CREATE TABLE syntax:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_name">Table</span><span class="python_operator">, </span><span class="python_name">Column</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_operator">, </span><span class="python_name">MetaData</span><span class="python_operator">, </span><span class="python_name">ForeignKey    </span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">MetaData</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">users_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
<span class="python_operator">...     </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_operator">...     </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_operator">...     </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'fullname'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_operator">...     </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'password'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">)</span>
<span class="python_operator">... </span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>All about how to define <code>Table</code> objects, as well as how to load their definition from an existing database (known as <strong>reflection</strong>), is described in <a href="metadata.html">Database Meta Data</a>.
</p>
<p>Next, we can issue CREATE TABLE statements derived from our table metadata, by calling <code>create_all()</code> and passing it the <code>engine</code> instance which points to our database.  This will check for the presence of a table first before creating, so it's safe to call multiple times:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_1', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">metadata</span><span class="python_operator">.</span><span class="python_name">create_all</span><span class="python_enclosure">(</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator"> </span></pre><div id="popbox_1_div" class="codepop" style="display:none;">PRAGMA table_info(&quot;users&quot;)<br/>
{}<br/>
CREATE TABLE users (<br/>
    id INTEGER NOT NULL, <br/>
    name VARCHAR, <br/>
    fullname VARCHAR, <br/>
    password VARCHAR, <br/>
    PRIMARY KEY (id)<br/>
)<br/>
{}<br/>
COMMIT</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Users familiar with the syntax of CREATE TABLE may notice that the VARCHAR columns were generated without a length; on SQLite, this is a valid datatype, but on most databases it's not allowed.  So if running this tutorial on a database such as Postgres or MySQL, and you wish to use SQLAlchemy to generate the tables, a "length" may be provided to the <code>String</code> type as below:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">50</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>
<p>The length field on <code>String</code>, as well as similar precision/scale fields available on <code>Integer</code>, <code>Numeric</code>, etc. are not referenced by SQLAlchemy other than when creating tables.
</p>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_mapping"></a>
    
    <div class="sectionL2">

    <h3>Define a Python Class to be Mapped</h3>
    
    

<p>While the <code>Table</code> object defines information about our database, it does not say anything about the definition or behavior of the business objects used by our application;  SQLAlchemy views this as a separate concern.  To correspond to our <code>users</code> table, let's create a rudimentary <code>User</code> class.  It only need subclass Python's built-in <code>object</code> class (i.e. it's a new style class):
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
...     </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">fullname</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_enclosure">)</span><span class="python_operator">:
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">= </span><span class="python_name">name</span><span class="python_operator">
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">fullname </span><span class="python_operator">= </span><span class="python_name">fullname</span><span class="python_operator">
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">password</span><span class="python_operator">
...
...     </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
...        </span><span class="python_keyword">return </span><span class="python_literal">"&lt;User('%s','%s', '%s')&gt;" </span><span class="python_operator">% </span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">fullname</span><span class="python_operator">, </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>The class has an <code>__init__()</code> and a <code>__repr__()</code> method for convenience.  These methods are both entirely optional, and can be of any form.  SQLAlchemy never calls <code>__init__()</code> directly.
</p>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_setting"></a>
    
    <div class="sectionL2">

    <h3>Setting up the Mapping</h3>
    
    

<p>With our <code>users_table</code> and <code>User</code> class, we now want to map the two together.  That's where the SQLAlchemy ORM package comes in.  We'll use the <code>mapper</code> function to create a <strong>mapping</strong> between <code>users_table</code> and <code>User</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">orm </span><span class="python_keyword">import </span><span class="python_name">mapper</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_enclosure">) </span><span class="python_operator">
&lt;</span><span class="python_name">Mapper at </span><span class="python_number">0x</span><span class="python_operator">...; </span><span class="python_name">User</span><span class="python_operator">&gt;
</span></pre>
    </div>
<p>The <code>mapper()</code> function creates a new <code>Mapper</code> object and stores it away for future reference, associated with our class.  Let's now create and inspect a <code>User</code> object:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">ed_user </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">, </span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'edspassword'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">ed_user</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">
</span><span class="python_literal">'ed'</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">ed_user</span><span class="python_operator">.</span><span class="python_name">password</span><span class="python_operator">
</span><span class="python_literal">'edspassword'</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">str</span><span class="python_enclosure">(</span><span class="python_name">ed_user</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal">'None'</span><span class="python_operator">
</span></pre>
    </div>
<p>The <code>id</code> attribute, which while not defined by our <code>__init__()</code> method, exists due to the <code>id</code> column present within the <code>users_table</code> object.  By default, the <code>mapper</code> creates class attributes for all columns present within the <code>Table</code>.  These class attributes exist as Python descriptors, and define <strong>instrumentation</strong> for the mapped class.  The functionality of this instrumentation is very rich and includes the ability to track modifications and automatically load new data from the database when needed.
</p>
<p>Since we have not yet told SQLAlchemy to persist <code>Ed Jones</code> within the database, its id is <code>None</code>.  When we persist the object later, this attribute will be populated with a newly generated value.
</p>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_declarative"></a>
    
    <div class="sectionL2">

    <h3>Creating Table, Class and Mapper All at Once Declaratively</h3>
    
    

<p>The preceding approach to configuration involving a <code>Table</code>, user-defined class, and <code>mapper()</code> call illustrate classical SQLAlchemy usage, which values the highest separation of concerns possible.  A large number of applications don't require this degree of separation, and for those SQLAlchemy offers an alternate "shorthand" configurational style called <strong>declarative</strong>.  For many applications, this is the only style of configuration needed.  Our above example using this style is as follows:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">ext</span><span class="python_operator">.</span><span class="python_name">declarative </span><span class="python_keyword">import </span><span class="python_name">declarative_base</span><span class="python_operator">
</span>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">Base </span><span class="python_operator">= </span><span class="python_name">declarative_base</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">Base</span><span class="python_enclosure">)</span><span class="python_operator">:
...     </span><span class="python_name">__tablename__ </span><span class="python_operator">= </span><span class="python_literal">'users'</span><span class="python_operator">
...
...     </span><span class="python_name">id </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
...     </span><span class="python_name">name </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">String</span><span class="python_enclosure">)</span><span class="python_operator">
...     </span><span class="python_name">fullname </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">String</span><span class="python_enclosure">)</span><span class="python_operator">
...     </span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">String</span><span class="python_enclosure">)</span><span class="python_operator">
...
...     </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">fullname</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_enclosure">)</span><span class="python_operator">:
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">= </span><span class="python_name">name</span><span class="python_operator">
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">fullname </span><span class="python_operator">= </span><span class="python_name">fullname</span><span class="python_operator">
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">password</span><span class="python_operator">
...
...     </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
...        </span><span class="python_keyword">return </span><span class="python_literal">"&lt;User('%s','%s', '%s')&gt;" </span><span class="python_operator">% </span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">fullname</span><span class="python_operator">, </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>Above, the <code>declarative_base()</code> function defines a new class which we name <code>Base</code>, from which all of our ORM-enabled classes will derive.  Note that we define <code>Column</code> objects with no "name" field, since it's inferred from the given attribute name.
</p>
<p>The underlying <code>Table</code> object created by our <code>declarative_base()</code> version of <code>User</code> is accessible via the <code>__table__</code> attribute:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">users_table </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">__table__</span><span class="python_operator">
</span></pre>
    </div>
<p>and the owning <code>MetaData</code> object is available as well:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">Base</span><span class="python_operator">.</span><span class="python_name">metadata</span><span class="python_operator">
</span></pre>
    </div>
<p>Yet another "declarative" method is available for SQLAlchemy as a third party library called <a href='http://elixir.ematia.de/'>Elixir</a>.  This is a full-featured configurational product which also includes many higher level mapping configurations built in.  Like declarative, once classes and mappings are defined, ORM usage is the same as with a classical SQLAlchemy configuration.
</p>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_creating"></a>
    
    <div class="sectionL2">

    <h3>Creating a Session</h3>
    
    

<p>We're now ready to start talking to the database.  The ORM's "handle" to the database is the <code>Session</code>.  When we first set up the application, at the same level as our <code>create_engine()</code> statement, we define a <code>Session</code> class which will serve as a factory for new <code>Session</code> objects:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">orm </span><span class="python_keyword">import </span><span class="python_name">sessionmaker</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">Session </span><span class="python_operator">= </span><span class="python_name">sessionmaker</span><span class="python_enclosure">(</span><span class="python_name">bind</span><span class="python_operator">=</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>In the case where your application does not yet have an <code>Engine</code> when you define your module-level objects, just set it up like this:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">Session </span><span class="python_operator">= </span><span class="python_name">sessionmaker</span><span class="python_enclosure">()</span><span class="python_operator">
</span></pre>
    </div>
<p>Later, when you create your engine with <code>create_engine()</code>, connect it to the <code>Session</code> using <code>configure()</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">Session</span><span class="python_operator">.</span><span class="python_name">configure</span><span class="python_enclosure">(</span><span class="python_name">bind</span><span class="python_operator">=</span><span class="python_name">engine</span><span class="python_enclosure">)  </span><span class="python_comment"># once engine is available</span><span class="python_operator">
</span></pre>
    </div>
<p>This custom-made <code>Session</code> class will create new <code>Session</code> objects which are bound to our database.  Other transactional characteristics may be defined when calling <code>sessionmaker()</code> as well; these are described in a later chapter.  Then, whenever you need to have a conversation with the database, you instantiate a <code>Session</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">Session</span><span class="python_enclosure">()</span><span class="python_operator">
</span></pre>
    </div>
<p>The above <code>Session</code> is associated with our SQLite <code>engine</code>, but it hasn't opened any connections yet.  When it's first used, it retrieves a connection from a pool of connections maintained by the <code>engine</code>, and holds onto it until we commit all changes and/or close the session object.
</p>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_adding"></a>
    
    <div class="sectionL2">

    <h3>Adding new Objects</h3>
    
    

<p>To persist our <code>User</code> object, we <code>add()</code> it to our <code>Session</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">ed_user </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">, </span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'edspassword'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">add</span><span class="python_enclosure">(</span><span class="python_name">ed_user</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>At this point, the instance is <strong>pending</strong>; no SQL has yet been issued.  The <code>Session</code> will issue the SQL to persist <code>Ed Jones</code> as soon as is needed, using a process known as a <strong>flush</strong>.  If we query the database for <code>Ed Jones</code>, all pending information will first be flushed, and the query is issued afterwards.
</p>
<p>For example, below we create a new <code>Query</code> object which loads instances of <code>User</code>.  We "filter by" the <code>name</code> attribute of <code>ed</code>, and indicate that we'd like only the first result in the full list of rows.  A <code>User</code> instance is returned which is equivalent to that which we've added:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_2', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">our_user </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'ed'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">first</span><span class="python_enclosure">()</span><span class="python_operator"> </span></pre><div id="popbox_2_div" class="codepop" style="display:none;">BEGIN<br/>
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)<br/>
['ed', 'Ed Jones', 'edspassword']<br/>
SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name = ?<br/>
 LIMIT 1 OFFSET 0<br/>
['ed']</div><pre><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">our_user</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'edspassword'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span></pre>
    </div>
<p>In fact, the <code>Session</code> has identified that the row returned is the <strong>same</strong> row as one already represented within its internal map of objects, so we actually got back the identical instance as that which we just added:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">ed_user </span><span class="python_keyword">is </span><span class="python_name">our_user</span><span class="python_operator">
</span><span class="python_name">True</span><span class="python_operator">
</span></pre>
    </div>
<p>The ORM concept at work here is known as an <strong>identity map</strong> and ensures that all operations upon a particular row within a <code>Session</code> operate upon the same set of data.  Once an object with a particular primary key is present in the <code>Session</code>, all SQL queries on that <code>Session</code> will always return the same Python object for that particular primary key; it also will raise an error if an attempt is made to place a second, already-persisted object with the same primary key within the session.
</p>
<p>We can add more <code>User</code> objects at once using <code>add_all()</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">add_all</span><span class="python_enclosure">([</span>
<span class="python_operator">...     </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_operator">, </span><span class="python_literal">'Wendy Williams'</span><span class="python_operator">, </span><span class="python_literal">'foobar'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_operator">...     </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'mary'</span><span class="python_operator">, </span><span class="python_literal">'Mary Contrary'</span><span class="python_operator">, </span><span class="python_literal">'xxg527'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_operator">...     </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_operator">, </span><span class="python_literal">'Fred Flinstone'</span><span class="python_operator">, </span><span class="python_literal">'blah'</span><span class="python_enclosure">)])</span><span class="python_operator">
</span></pre>
    </div>
<p>Also, Ed has already decided his password isn't too secure, so lets change it:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">ed_user</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_literal">'f8s7ccs'</span><span class="python_operator">
</span></pre>
    </div>
<p>The <code>Session</code> is paying attention.  It knows, for example, that <code>Ed Jones</code> has been modified:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">dirty</span><span class="python_operator">
</span><span class="python_name">IdentitySet</span><span class="python_enclosure">([</span><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'f8s7ccs'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">])</span><span class="python_operator">
</span></pre>
    </div>
<p>and that three new <code>User</code> objects are pending:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">new  </span><span class="python_operator">
</span><span class="python_name">IdentitySet</span><span class="python_enclosure">([</span><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_operator">,</span><span class="python_literal">'Wendy Williams'</span><span class="python_operator">, </span><span class="python_literal">'foobar'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;, </span>
<span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'mary'</span><span class="python_operator">,</span><span class="python_literal">'Mary Contrary'</span><span class="python_operator">, </span><span class="python_literal">'xxg527'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;, </span>
<span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_operator">,</span><span class="python_literal">'Fred Flinstone'</span><span class="python_operator">, </span><span class="python_literal">'blah'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">])</span><span class="python_operator">
</span></pre>
    </div>
<p>We tell the <code>Session</code> that we'd like to issue all remaining changes to the database and commit the transaction, which has been in progress throughout.  We do this via <code>commit()</code>:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_3', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_3_div" class="codepop" style="display:none;">UPDATE users SET password=? WHERE users.id = ?<br/>
['f8s7ccs', 1]<br/>
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)<br/>
['wendy', 'Wendy Williams', 'foobar']<br/>
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)<br/>
['mary', 'Mary Contrary', 'xxg527']<br/>
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)<br/>
['fred', 'Fred Flinstone', 'blah']<br/>
COMMIT</div><pre><span class="python_operator"></span></pre>
    </div>
<p><code>commit()</code> flushes whatever remaining changes remain to the database, and commits the transaction.  The connection resources referenced by the session are now returned to the connection pool.  Subsequent operations with this session will occur in a <strong>new</strong> transaction, which will again re-acquire connection resources when first needed.
</p>
<p>If we look at Ed's <code>id</code> attribute, which earlier was <code>None</code>, it now has a value:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_4', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">ed_user</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_operator"> </span></pre><div id="popbox_4_div" class="codepop" style="display:none;">BEGIN<br/>
SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.id = ?<br/>
[1]</div><pre><span class="python_number">1</span><span class="python_operator">
</span></pre>
    </div>
<p>After the <code>Session</code> inserts new rows in the database, all newly generated identifiers and database-generated defaults become available on the instance, either immediately or via load-on-first-access.  In this case, the entire row was re-loaded on access because a new transaction was begun after we issued <code>commit()</code>.  SQLAlchemy by default refreshes data from a previous transaction the first time it's accessed within a new transaction, so that the most recent state is available.  The level of reloading is configurable as is described in the chapter on Sessions.
</p>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_rolling"></a>
    
    <div class="sectionL2">

    <h3>Rolling Back</h3>
    
    

<p>Since the <code>Session</code> works within a transaction, we can roll back changes made too.   Let's make two changes that we'll revert; <code>ed_user</code>'s user name gets set to <code>Edwardo</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">ed_user</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">= </span><span class="python_literal">'Edwardo'</span><span class="python_operator">
</span></pre>
    </div>
<p>and we'll add another erroneous user, <code>fake_user</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">fake_user </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fakeuser'</span><span class="python_operator">, </span><span class="python_literal">'Invalid'</span><span class="python_operator">, </span><span class="python_literal">'12345'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">add</span><span class="python_enclosure">(</span><span class="python_name">fake_user</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>Querying the session, we can see that they're flushed into the current transaction:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_5', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">in_</span><span class="python_enclosure">([</span><span class="python_literal">'Edwardo'</span><span class="python_operator">, </span><span class="python_literal">'fakeuser'</span><span class="python_enclosure">]))</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_5_div" class="codepop" style="display:none;">UPDATE users SET name=? WHERE users.id = ?<br/>
['Edwardo', 1]<br/>
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)<br/>
['fakeuser', 'Invalid', '12345']<br/>
SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name IN (?, ?)<br/>
['Edwardo', 'fakeuser']</div><pre><span class="python_enclosure">[</span><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'Edwardo'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'f8s7ccs'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;, &lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fakeuser'</span><span class="python_operator">,</span><span class="python_literal">'Invalid'</span><span class="python_operator">, </span><span class="python_literal">'12345'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">]</span><span class="python_operator">
</span></pre>
    </div>
<p>Rolling back, we can see that <code>ed_user</code>'s name is back to <code>ed</code>, and <code>fake_user</code> has been kicked out of the session:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_6', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">rollback</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_6_div" class="codepop" style="display:none;">ROLLBACK</div><pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_7', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">ed_user</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_7_div" class="codepop" style="display:none;">BEGIN<br/>
SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.id = ?<br/>
[1]</div><pre><span class="python_literal">u'ed'</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">fake_user </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">
</span><span class="python_name">False</span><span class="python_operator">
</span></pre>
    </div>
<p>issuing a SELECT illustrates the changes made to the database:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_8', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">in_</span><span class="python_enclosure">([</span><span class="python_literal">'ed'</span><span class="python_operator">, </span><span class="python_literal">'fakeuser'</span><span class="python_enclosure">]))</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_8_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name IN (?, ?)<br/>
['ed', 'fakeuser']</div><pre><span class="python_enclosure">[</span><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'f8s7ccs'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">]</span><span class="python_operator">
</span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_querying"></a>
    
    <div class="sectionL2">

    <h3>Querying</h3>
    
    

<p>A <code>Query</code> is created using the <code>query()</code> function on <code>Session</code>.  This function takes a variable number of arguments, which can be any combination of classes and class-instrumented descriptors.  Below, we indicate a <code>Query</code> which loads <code>User</code> instances.  When evaluated in an iterative context, the list of <code>User</code> objects present is returned:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_9', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">instance </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">order_by</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_enclosure">)</span><span class="python_operator">: 
...     </span><span class="python_keyword">print </span><span class="python_name">instance</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">instance</span><span class="python_operator">.</span><span class="python_name">fullname</span><span class="python_operator"> </span></pre><div id="popbox_9_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users ORDER BY users.id<br/>
[]</div><pre><span class="python_name">ed Ed Jones</span><span class="python_operator">
</span><span class="python_name">wendy Wendy Williams</span><span class="python_operator">
</span><span class="python_name">mary Mary Contrary</span><span class="python_operator">
</span><span class="python_name">fred Fred Flinstone</span><span class="python_operator">
</span></pre>
    </div>
<p>The <code>Query</code> also accepts ORM-instrumented descriptors as arguments.  Any time multiple class entities or column-based entities are expressed as arguments to the <code>query()</code> function, the return result is expressed as tuples:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_10', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">fullname </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">fullname</span><span class="python_enclosure">)</span><span class="python_operator">: 
...     </span><span class="python_keyword">print </span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">fullname</span><span class="python_operator"></span></pre><div id="popbox_10_div" class="codepop" style="display:none;">SELECT users.name AS users_name, users.fullname AS users_fullname<br/>
FROM users<br/>
[]</div><pre><span class="python_name">ed Ed Jones</span><span class="python_operator">
</span><span class="python_name">wendy Wendy Williams</span><span class="python_operator">
</span><span class="python_name">mary Mary Contrary</span><span class="python_operator">
</span><span class="python_name">fred Fred Flinstone</span><span class="python_operator">
</span></pre>
    </div>
<p>The tuples returned by <code>Query</code> are <em>named</em> tuples, and can be treated much like an ordinary Python object.  The names are the same as the attribute's name for an attribute, and the class name for a class:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_11', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">row </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator">:
...    </span><span class="python_keyword">print </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_11_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users<br/>
[]</div><pre><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'f8s7ccs'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; </span><span class="python_name">ed</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_operator">,</span><span class="python_literal">'Wendy Williams'</span><span class="python_operator">, </span><span class="python_literal">'foobar'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; </span><span class="python_name">wendy</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'mary'</span><span class="python_operator">,</span><span class="python_literal">'Mary Contrary'</span><span class="python_operator">, </span><span class="python_literal">'xxg527'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; </span><span class="python_name">mary</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_operator">,</span><span class="python_literal">'Fred Flinstone'</span><span class="python_operator">, </span><span class="python_literal">'blah'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; </span><span class="python_name">fred</span><span class="python_operator">
</span></pre>
    </div>
<p>You can control the names using the <code>label()</code> construct for scalar attributes and <code>aliased()</code> for class constructs:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">orm </span><span class="python_keyword">import </span><span class="python_name">aliased</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">user_alias </span><span class="python_operator">= </span><span class="python_name">aliased</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'user_alias'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_12', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">row </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">user_alias</span><span class="python_operator">, </span><span class="python_name">user_alias</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">label</span><span class="python_enclosure">(</span><span class="python_literal">'name_label'</span><span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator">:
...    </span><span class="python_keyword">print </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">user_alias</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">name_label</span><span class="python_operator"></span></pre><div id="popbox_12_div" class="codepop" style="display:none;">SELECT users_1.id AS users_1_id, users_1.name AS users_1_name, users_1.fullname AS users_1_fullname, users_1.password AS users_1_password, users_1.name AS name_label <br/>
FROM users AS users_1<br/>
[]<br/>
&lt;User('ed','Ed Jones', 'f8s7ccs')&gt; ed<br/>
&lt;User('wendy','Wendy Williams', 'foobar')&gt; wendy<br/>
&lt;User('mary','Mary Contrary', 'xxg527')&gt; mary<br/>
&lt;User('fred','Fred Flinstone', 'blah')&gt; fred</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Basic operations with <code>Query</code> include issuing LIMIT and OFFSET, most conveniently using Python array slices and typically in conjunction with ORDER BY:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_13', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">u </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">order_by</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_enclosure">)[</span><span class="python_number">1</span><span class="python_operator">:</span><span class="python_number">3</span><span class="python_enclosure">]</span><span class="python_operator">: 
...    </span><span class="python_keyword">print </span><span class="python_name">u</span><span class="python_operator"></span></pre><div id="popbox_13_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users ORDER BY users.id <br/>
LIMIT 2 OFFSET 1<br/>
[]</div><pre><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_operator">,</span><span class="python_literal">'Wendy Williams'</span><span class="python_operator">, </span><span class="python_literal">'foobar'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'mary'</span><span class="python_operator">,</span><span class="python_literal">'Mary Contrary'</span><span class="python_operator">, </span><span class="python_literal">'xxg527'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span></pre>
    </div>
<p>and filtering results, which is accomplished either with <code>filter_by()</code>, which uses keyword arguments:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_14', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">fullname</span><span class="python_operator">=</span><span class="python_literal">'Ed Jones'</span><span class="python_enclosure">)</span><span class="python_operator">: 
...    </span><span class="python_keyword">print </span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_14_div" class="codepop" style="display:none;">SELECT users.name AS users_name FROM users <br/>
WHERE users.fullname = ?<br/>
['Ed Jones']</div><pre><span class="python_name">ed</span><span class="python_operator">
</span></pre>
    </div>
<p>...or <code>filter()</code>, which uses more flexible SQL expression language constructs.  These allow you to use regular Python operators with the class-level attributes on your mapped class:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_15', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">fullname</span><span class="python_operator">==</span><span class="python_literal">'Ed Jones'</span><span class="python_enclosure">)</span><span class="python_operator">: 
...    </span><span class="python_keyword">print </span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_15_div" class="codepop" style="display:none;">SELECT users.name AS users_name FROM users <br/>
WHERE users.fullname = ?<br/>
['Ed Jones']</div><pre><span class="python_name">ed</span><span class="python_operator">
</span></pre>
    </div>
<p>The <code>Query</code> object is fully <em>generative</em>, meaning that most method calls return a new <code>Query</code> object upon which further criteria may be added.  For example, to query for users named "ed" with a full name of "Ed Jones", you can call <code>filter()</code> twice, which joins criteria using <code>AND</code>:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_16', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">user </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">==</span><span class="python_literal">'ed'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">fullname</span><span class="python_operator">==</span><span class="python_literal">'Ed Jones'</span><span class="python_enclosure">)</span><span class="python_operator">: 
...    </span><span class="python_keyword">print </span><span class="python_name">user</span><span class="python_operator"></span></pre><div id="popbox_16_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name = ? AND users.fullname = ?<br/>
['ed', 'Ed Jones']</div><pre><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'f8s7ccs'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span></pre>
    </div>


    
    <A name="datamapping_querying_common"></a>
    
    <div class="sectionL3">

    <h3>Common Filter Operators</h3>
    
    

<p>Here's a rundown of some of the most common operators used in <code>filter()</code>:
</p>
<ul>
 <li><p>equals
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'ed'</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>not equals
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'ed'</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>LIKE
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">like</span><span class="python_enclosure">(</span><span class="python_literal">'%ed%'</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>IN
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">in_</span><span class="python_enclosure">([</span><span class="python_literal">'ed'</span><span class="python_operator">, </span><span class="python_literal">'wendy'</span><span class="python_operator">, </span><span class="python_literal">'jack'</span><span class="python_enclosure">]))</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>IS NULL
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>AND
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_name">and_</span><span class="python_operator">
</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">and_</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'ed'</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">fullname </span><span class="python_operator">== </span><span class="python_literal">'Ed Jones'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># or call filter()/filter_by() multiple times
</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'ed'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">fullname </span><span class="python_operator">== </span><span class="python_literal">'Ed Jones'</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>OR
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_name">or_</span><span class="python_operator">
</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">or_</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'ed'</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'wendy'</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>match
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">match</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>
<p>The contents of the match parameter are database backend specific.
</p>

 </li>
</ul>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_querying_scalars"></a>
    
    <div class="sectionL3">

    <h3>Returning Lists and Scalars</h3>
    
    

<p>The <code>all()</code>, <code>one()</code>, and <code>first()</code> methods of <code>Query</code> immediately issue SQL and return a non-iterator value.  <code>all()</code> returns a list:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">query </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">like</span><span class="python_enclosure">(</span><span class="python_literal">'%ed'</span><span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">order_by</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_17', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_17_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name LIKE ? ORDER BY users.id<br/>
['%ed']</div><pre><span class="python_enclosure">[</span><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'f8s7ccs'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;, &lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_operator">,</span><span class="python_literal">'Fred Flinstone'</span><span class="python_operator">, </span><span class="python_literal">'blah'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">]</span><span class="python_operator">
</span></pre>
    </div>
<p><code>first()</code> applies a limit of one and returns the first result as a scalar:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_18', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">first</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_18_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name LIKE ? ORDER BY users.id <br/>
 LIMIT 1 OFFSET 0<br/>
['%ed']</div><pre><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'f8s7ccs'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span></pre>
    </div>
<p><code>one()</code>, applies a limit of <em>two</em>, and if not exactly one row returned, raises an error:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_19', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">try</span><span class="python_operator">:  
...     </span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">() </span><span class="python_operator">
... </span><span class="python_keyword">except </span><span class="python_name">Exception</span><span class="python_operator">, </span><span class="python_name">e</span><span class="python_operator">: 
...     </span><span class="python_keyword">print </span><span class="python_name">e</span><span class="python_operator"></span></pre><div id="popbox_19_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name LIKE ? ORDER BY users.id <br/>
 LIMIT 2 OFFSET 0<br/>
['%ed']</div><pre><span class="python_name">Multiple rows were found </span><span class="python_keyword">for </span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_20', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">try</span><span class="python_operator">:
...     </span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id </span><span class="python_operator">== </span><span class="python_number">99</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">() </span><span class="python_operator">
... </span><span class="python_keyword">except </span><span class="python_name">Exception</span><span class="python_operator">, </span><span class="python_name">e</span><span class="python_operator">: 
...     </span><span class="python_keyword">print </span><span class="python_name">e</span><span class="python_operator"></span></pre><div id="popbox_20_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name LIKE ? AND users.id = ? ORDER BY users.id <br/>
 LIMIT 2 OFFSET 0<br/>
['%ed', 99]</div><pre><span class="python_name">No row was found </span><span class="python_keyword">for </span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator">
</span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_querying_using"></a>
    
    <div class="sectionL3">

    <h3>Using Literal SQL</h3>
    
    

<p>Literal strings can be used flexibly with <code>Query</code>.  Most methods accept strings in addition to SQLAlchemy clause constructs.  For example, <code>filter()</code> and <code>order_by()</code>:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_21', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">user </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_literal">"id&lt;224"</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">order_by</span><span class="python_enclosure">(</span><span class="python_literal">"id"</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator">:
...     </span><span class="python_keyword">print </span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_21_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE id&lt;224 ORDER BY id<br/>
[]</div><pre><span class="python_name">ed</span><span class="python_operator">
</span><span class="python_name">wendy</span><span class="python_operator">
</span><span class="python_name">mary</span><span class="python_operator">
</span><span class="python_name">fred</span><span class="python_operator">
</span></pre>
    </div>
<p>Bind parameters can be specified with string-based SQL, using a colon.  To specify the values, use the <code>params()</code> method:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_22', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_literal">"id&lt;:value and name=:name"</span><span class="python_enclosure">)</span><span class="python_operator">.\
...     </span><span class="python_name">params</span><span class="python_enclosure">(</span><span class="python_name">value</span><span class="python_operator">=</span><span class="python_number">224</span><span class="python_operator">, </span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'fred'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">order_by</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator"> </span></pre><div id="popbox_22_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE id&lt;? and name=? ORDER BY users.id <br/>
LIMIT 2 OFFSET 0<br/>
[224, 'fred']</div><pre><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_operator">,</span><span class="python_literal">'Fred Flinstone'</span><span class="python_operator">, </span><span class="python_literal">'blah'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span></pre>
    </div>
<p>To use an entirely string-based statement, using <code>from_statement()</code>; just ensure that the columns clause of the statement contains the column names normally used by the mapper (below illustrated using an asterisk):
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_23', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">from_statement</span><span class="python_enclosure">(</span><span class="python_literal">"SELECT * FROM users where name=:name"</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">params</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'ed'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_23_div" class="codepop" style="display:none;">SELECT * FROM users where name=?<br/>
['ed']</div><pre><span class="python_enclosure">[</span><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'f8s7ccs'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">]</span><span class="python_operator">
</span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>




    </div>



    
    <A name="datamapping_relation"></a>
    
    <div class="sectionL2">

    <h3>Building a Relation</h3>
    
    

<p>Now let's consider a second table to be dealt with.  Users in our system also can store any number of email addresses associated with their username.  This implies a basic one to many association from the <code>users_table</code> to a new table which stores email addresses, which we will call <code>addresses</code>.  Using declarative, we define this table along with its mapped class, <code>Address</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_name">ForeignKey</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">orm </span><span class="python_keyword">import </span><span class="python_name">relation</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">class </span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_name">Base</span><span class="python_enclosure">)</span><span class="python_operator">:
...     </span><span class="python_name">__tablename__ </span><span class="python_operator">= </span><span class="python_literal">'addresses'</span><span class="python_operator">
...     </span><span class="python_name">id </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
...     </span><span class="python_name">email_address </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">String</span><span class="python_operator">, </span><span class="python_name">nullable</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">
...     </span><span class="python_name">user_id </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">'users.id'</span><span class="python_enclosure">))</span><span class="python_operator">
...
...     </span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_name">backref</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_operator">, </span><span class="python_name">order_by</span><span class="python_operator">=</span><span class="python_name">id</span><span class="python_enclosure">))</span><span class="python_operator">
...
...     </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">email_address</span><span class="python_enclosure">)</span><span class="python_operator">:
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">email_address </span><span class="python_operator">= </span><span class="python_name">email_address</span><span class="python_operator">
...
...     </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
...         </span><span class="python_keyword">return </span><span class="python_literal">"&lt;Address('%s')&gt;" </span><span class="python_operator">% </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">
</span></pre>
    </div>
<p>The above class introduces a <strong>foreign key</strong> constraint which references the <code>users</code> table.  This defines for SQLAlchemy the relationship between the two tables at the database level.  The relationship between the <code>User</code> and <code>Address</code> classes is defined separately using the <code>relation()</code> function, which defines an attribute <code>user</code> to be placed on the <code>Address</code> class, as well as an <code>addresses</code> collection to be placed on the <code>User</code> class.  Such a relation is known as a <strong>bidirectional</strong> relationship.   Because of the placement of the foreign key, from <code>Address</code> to <code>User</code> it is <strong>many to one</strong>, and from <code>User</code> to <code>Address</code> it is <strong>one to many</strong>.  SQLAlchemy is automatically aware of many-to-one/one-to-many based on foreign keys.
</p>
<p>The <code>relation()</code> function is extremely flexible, and could just have easily been defined on the <code>User</code> class:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">Base</span><span class="python_enclosure">)</span><span class="python_operator">:
    ....
    </span><span class="python_name">addresses </span><span class="python_operator">= </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">order_by</span><span class="python_operator">=</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">"user"</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>We are also free to not define a backref, and to define the <code>relation()</code> only on one class and not the other.   It is also possible to define two separate <code>relation()</code>s for either direction, which is generally safe for many-to-one and one-to-many relations, but not for many-to-many relations.
</p>
<p>When using the <code>declarative</code> extension, <code>relation()</code> gives us the option to use strings for most arguments that concern the target class, in the case that the target class has not yet been defined.  This <strong>only</strong> works in conjunction with <code>declarative</code>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">Base</span><span class="python_enclosure">)</span><span class="python_operator">:
    ....
    </span><span class="python_name">addresses </span><span class="python_operator">= </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_literal">"Address"</span><span class="python_operator">, </span><span class="python_name">order_by</span><span class="python_operator">=</span><span class="python_literal">"Address.id"</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">"user"</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>When <code>declarative</code> is not in use, you typically define your <code>mapper()</code> well after the target classes and <code>Table</code> objects have been defined, so string expressions are not needed.
</p>
<p>We'll need to create the <code>addresses</code> table in the database, so we will issue another CREATE from our metadata, which will skip over tables which have already been created:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_24', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">metadata</span><span class="python_operator">.</span><span class="python_name">create_all</span><span class="python_enclosure">(</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator"> </span></pre><div id="popbox_24_div" class="codepop" style="display:none;">PRAGMA table_info(&quot;users&quot;)<br/>
{}<br/>
PRAGMA table_info(&quot;addresses&quot;)<br/>
{}<br/>
CREATE TABLE addresses (<br/>
    id INTEGER NOT NULL, <br/>
    email_address VARCHAR NOT NULL, <br/>
    user_id INTEGER, <br/>
    PRIMARY KEY (id), <br/>
     FOREIGN KEY(user_id) REFERENCES users (id)<br/>
)<br/>
{}<br/>
COMMIT</div><pre><span class="python_operator"></span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_related_objects"></a>
    
    <div class="sectionL2">

    <h3>Working with Related Objects</h3>
    
    

<p>Now when we create a <code>User</code>, a blank <code>addresses</code> collection will be present.  By default, the collection is a Python list.  Other collection types, such as sets and dictionaries, are available as well:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">jack </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jack'</span><span class="python_operator">, </span><span class="python_literal">'Jack Bean'</span><span class="python_operator">, </span><span class="python_literal">'gjffdd'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">jack</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">
</span><span class="python_enclosure">[]</span><span class="python_operator">
</span></pre>
    </div>
<p>We are free to add <code>Address</code> objects on our <code>User</code> object.  In this case we just assign a full list directly:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">jack</span><span class="python_operator">.</span><span class="python_name">addresses </span><span class="python_operator">= </span><span class="python_enclosure">[</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_name">email_address</span><span class="python_operator">=</span><span class="python_literal">'jack@google.com'</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_name">email_address</span><span class="python_operator">=</span><span class="python_literal">'j25@yahoo.com'</span><span class="python_enclosure">)]</span><span class="python_operator">
</span></pre>
    </div>
<p>When using a bidirectional relationship, elements added in one direction automatically become visible in the other direction.  This is the basic behavior of the <strong>backref</strong> keyword, which maintains the relationship purely in memory, without using any SQL:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">jack</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">[</span><span class="python_number">1</span><span class="python_enclosure">]</span><span class="python_operator">
&lt;</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'j25@yahoo.com'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">jack</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">[</span><span class="python_number">1</span><span class="python_enclosure">]</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jack'</span><span class="python_operator">,</span><span class="python_literal">'Jack Bean'</span><span class="python_operator">, </span><span class="python_literal">'gjffdd'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span></pre>
    </div>
<p>Let's add and commit <code>Jack Bean</code> to the database.  <code>jack</code> as well as the two <code>Address</code> members in his <code>addresses</code> collection are both added to the session at once, using a process known as <strong>cascading</strong>:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">add</span><span class="python_enclosure">(</span><span class="python_name">jack</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_25', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_25_div" class="codepop" style="display:none;">INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)<br/>
['jack', 'Jack Bean', 'gjffdd']<br/>
INSERT INTO addresses (email_address, user_id) VALUES (?, ?)<br/>
['jack@google.com', 5]<br/>
INSERT INTO addresses (email_address, user_id) VALUES (?, ?)<br/>
['j25@yahoo.com', 5]<br/>
COMMIT</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Querying for Jack, we get just Jack back.  No SQL is yet issued for Jack's addresses:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_26', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">jack </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'jack'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_26_div" class="codepop" style="display:none;">BEGIN<br/>
SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name = ? <br/>
 LIMIT 2 OFFSET 0<br/>
['jack']</div><pre><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">jack</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jack'</span><span class="python_operator">,</span><span class="python_literal">'Jack Bean'</span><span class="python_operator">, </span><span class="python_literal">'gjffdd'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span></pre>
    </div>
<p>Let's look at the <code>addresses</code> collection.  Watch the SQL:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_27', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">jack</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator"></span></pre><div id="popbox_27_div" class="codepop" style="display:none;">SELECT addresses.id AS addresses_id, addresses.email_address AS addresses_email_address, addresses.user_id AS addresses_user_id <br/>
FROM addresses <br/>
WHERE ? = addresses.user_id ORDER BY addresses.id<br/>
[5]</div><pre><span class="python_enclosure">[</span><span class="python_operator">&lt;</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'jack@google.com'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;, &lt;</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'j25@yahoo.com'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">]</span><span class="python_operator">
</span></pre>
    </div>
<p>When we accessed the <code>addresses</code> collection, SQL was suddenly issued.  This is an example of a <strong>lazy loading relation</strong>.  The <code>addresses</code> collection is now loaded and behaves just like an ordinary list.  <br></br>
</p>
<p>If you want to reduce the number of queries (dramatically, in many cases), we can apply an <strong>eager load</strong> to the query operation.   With the same query, we may apply an <strong>option</strong> to the query, indicating that we'd like <code>addresses</code> to load "eagerly".  SQLAlchemy then constructs an outer join between the <code>users</code> and <code>addresses</code> tables, and loads them at once, populating the <code>addresses</code> collection on each <code>User</code> object if it's not already populated:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">orm </span><span class="python_keyword">import </span><span class="python_name">eagerload</span><span class="python_operator">
</span>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_28', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">jack </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">eagerload</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'jack'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator"> </span></pre><div id="popbox_28_div" class="codepop" style="display:none;">SELECT anon_1.users_id AS anon_1_users_id, anon_1.users_name AS anon_1_users_name, <br/>
anon_1.users_fullname AS anon_1_users_fullname, anon_1.users_password AS anon_1_users_password, <br/>
addresses_1.id AS addresses_1_id, addresses_1.email_address AS addresses_1_email_address, <br/>
addresses_1.user_id AS addresses_1_user_id <br/>
    FROM (SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, <br/>
    users.password AS users_password<br/>
    FROM users WHERE users.name = ? <br/>
     LIMIT 2 OFFSET 0) AS anon_1 LEFT OUTER JOIN addresses AS addresses_1 <br/>
     ON anon_1.users_id = addresses_1.user_id ORDER BY addresses_1.id<br/>
    ['jack']</div><pre><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">jack</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jack'</span><span class="python_operator">,</span><span class="python_literal">'Jack Bean'</span><span class="python_operator">, </span><span class="python_literal">'gjffdd'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">jack</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">
</span><span class="python_enclosure">[</span><span class="python_operator">&lt;</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'jack@google.com'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;, &lt;</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'j25@yahoo.com'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">]</span><span class="python_operator">
</span></pre>
    </div>
<p>SQLAlchemy has the ability to control exactly which attributes and how many levels deep should be joined together in a single SQL query.  More information on this feature is available in <a href="mappers.html#advdatamapping_relation">Relation Configuration</a>.
</p>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_joins"></a>
    
    <div class="sectionL2">

    <h3>Querying with Joins</h3>
    
    

<p>While the eager load created a JOIN specifically to populate a collection, we can also work explicitly with joins in many ways.  For example, to construct a simple inner join between <code>User</code> and <code>Address</code>, we can just <code>filter()</code> their related columns together.  Below we load the <code>User</code> and <code>Address</code> entities at once using this method:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_29', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">u</span><span class="python_operator">, </span><span class="python_name">a </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_operator">==</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)</span><span class="python_operator">.\
...         </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">==</span><span class="python_literal">'jack@google.com'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator">:   
...     </span><span class="python_keyword">print </span><span class="python_name">u</span><span class="python_operator">, </span><span class="python_name">a</span><span class="python_operator"></span></pre><div id="popbox_29_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, <br/>
users.password AS users_password, addresses.id AS addresses_id, <br/>
addresses.email_address AS addresses_email_address, addresses.user_id AS addresses_user_id <br/>
FROM users, addresses <br/>
WHERE users.id = addresses.user_id AND addresses.email_address = ?<br/>
['jack@google.com']</div><pre><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jack'</span><span class="python_operator">,</span><span class="python_literal">'Jack Bean'</span><span class="python_operator">, </span><span class="python_literal">'gjffdd'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; &lt;</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'jack@google.com'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;
</span></pre>
    </div>
<p>Or we can make a real JOIN construct; one way to do so is to use the ORM <code>join()</code> function, and tell <code>Query</code> to "select from" this join:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">orm </span><span class="python_keyword">import </span><span class="python_name">join</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_30', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">select_from</span><span class="python_enclosure">(</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">Address</span><span class="python_enclosure">))</span><span class="python_operator">.\
...         </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">==</span><span class="python_literal">'jack@google.com'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_30_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users JOIN addresses ON users.id = addresses.user_id <br/>
WHERE addresses.email_address = ?<br/>
['jack@google.com']</div><pre><span class="python_enclosure">[</span><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jack'</span><span class="python_operator">,</span><span class="python_literal">'Jack Bean'</span><span class="python_operator">, </span><span class="python_literal">'gjffdd'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">]</span><span class="python_operator">
</span></pre>
    </div>
<p><code>join()</code> knows how to join between <code>User</code> and <code>Address</code> because there's only one foreign key between them.  If there were no foreign keys, or several, <code>join()</code> would require a third argument indicating the ON clause of the join, in one of the following forms:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_operator">==</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)  </span><span class="python_comment"># explicit condition</span><span class="python_operator">
</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">)            </span><span class="python_comment"># specify relation from left to right</span><span class="python_operator">
</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_literal">'addresses'</span><span class="python_enclosure">)               </span><span class="python_comment"># same, using a string</span><span class="python_operator">
</span></pre>
    </div>
<p>The functionality of <code>join()</code> is also available generatively from <code>Query</code> itself using <code>Query.join</code>.  This is most easily used with just the "ON" clause portion of the join, such as:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_31', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">)</span><span class="python_operator">.\
...     </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">==</span><span class="python_literal">'jack@google.com'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_31_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users JOIN addresses ON users.id = addresses.user_id <br/>
WHERE addresses.email_address = ?<br/>
['jack@google.com']</div><pre><span class="python_enclosure">[</span><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jack'</span><span class="python_operator">,</span><span class="python_literal">'Jack Bean'</span><span class="python_operator">, </span><span class="python_literal">'gjffdd'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">]</span><span class="python_operator">
</span></pre>
    </div>
<p>To explicitly specify the target of the join, use tuples to form an argument list similar to the standalone join.  This becomes more important when using aliases and similar constructs:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">((</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>
<p>Multiple joins can be created by passing a list of arguments:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Foo</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_name">Foo</span><span class="python_operator">.</span><span class="python_name">bars</span><span class="python_operator">, </span><span class="python_name">Bar</span><span class="python_operator">.</span><span class="python_name">bats</span><span class="python_operator">, </span><span class="python_enclosure">(</span><span class="python_name">Bat</span><span class="python_operator">, </span><span class="python_literal">'widgets'</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>
<p>The above would produce SQL something like <code>foo JOIN bars ON &lt;onclause&gt; JOIN bats ON &lt;onclause&gt; JOIN widgets ON &lt;onclause&gt;</code>.
</p>


    
    <A name="datamapping_joins_aliases"></a>
    
    <div class="sectionL3">

    <h3>Using Aliases</h3>
    
    

<p>When querying across multiple tables, if the same table needs to be referenced more than once, SQL typically requires that the table be <em>aliased</em> with another name, so that it can be distinguished against other occurrences of that table.  The <code>Query</code> supports this most explicitly using the <code>aliased</code> construct.  Below we join to the <code>Address</code> entity twice, to locate a user who has two distinct email addresses at the same time:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">orm </span><span class="python_keyword">import </span><span class="python_name">aliased</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">adalias1 </span><span class="python_operator">= </span><span class="python_name">aliased</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">adalias2 </span><span class="python_operator">= </span><span class="python_name">aliased</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_32', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">username</span><span class="python_operator">, </span><span class="python_name">email1</span><span class="python_operator">, </span><span class="python_name">email2 </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">adalias1</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">, </span><span class="python_name">adalias2</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_enclosure">)</span><span class="python_operator">.\
...     </span><span class="python_name">join</span><span class="python_enclosure">((</span><span class="python_name">adalias1</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_enclosure">(</span><span class="python_name">adalias2</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">))</span><span class="python_operator">.\
...     </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">adalias1</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">==</span><span class="python_literal">'jack@google.com'</span><span class="python_enclosure">)</span><span class="python_operator">.\
...     </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">adalias2</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">==</span><span class="python_literal">'j25@yahoo.com'</span><span class="python_enclosure">)</span><span class="python_operator">:
...     </span><span class="python_keyword">print </span><span class="python_name">username</span><span class="python_operator">, </span><span class="python_name">email1</span><span class="python_operator">, </span><span class="python_name">email2</span><span class="python_operator">      </span></pre><div id="popbox_32_div" class="codepop" style="display:none;">SELECT users.name AS users_name, addresses_1.email_address AS addresses_1_email_address, <br/>
addresses_2.email_address AS addresses_2_email_address <br/>
FROM users JOIN addresses AS addresses_1 ON users.id = addresses_1.user_id <br/>
JOIN addresses AS addresses_2 ON users.id = addresses_2.user_id <br/>
WHERE addresses_1.email_address = ? AND addresses_2.email_address = ?<br/>
['jack@google.com', 'j25@yahoo.com']</div><pre><span class="python_name">jack jack</span><span class="python_operator">@</span><span class="python_name">google</span><span class="python_operator">.</span><span class="python_name">com j25</span><span class="python_operator">@</span><span class="python_name">yahoo</span><span class="python_operator">.</span><span class="python_name">com</span><span class="python_operator">
</span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_joins_subqueries"></a>
    
    <div class="sectionL3">

    <h3>Using Subqueries</h3>
    
    

<p>The <code>Query</code> is suitable for generating statements which can be used as subqueries.  Suppose we wanted to load <code>User</code> objects along with a count of how many <code>Address</code> records each user has.  The best way to generate SQL like this is to get the count of addresses grouped by user ids, and JOIN to the parent.  In this case we use a LEFT OUTER JOIN so that we get rows back for those users who don't have any addresses, e.g.:
</p>

    

    <div class="sliding_code">
        <pre>
SELECT users.*, adr_count.address_count FROM users LEFT OUTER JOIN
    (SELECT user_id, count(*) AS address_count FROM addresses GROUP BY user_id) AS adr_count
    ON users.id=adr_count.user_id
</pre>
    </div>
<p>Using the <code>Query</code>, we build a statement like this from the inside out.  The <code>statement</code> accessor returns a SQL expression representing the statement generated by a particular <code>Query</code> - this is an instance of a <code>select()</code> construct, which are described in <a href="sqlexpression.html">SQL Expression Language Tutorial</a>:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">sql </span><span class="python_keyword">import </span><span class="python_name">func</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">stmt </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">, </span><span class="python_name">func</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">(</span><span class="python_literal">'*'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">label</span><span class="python_enclosure">(</span><span class="python_literal">'address_count'</span><span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">group_by</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">subquery</span><span class="python_enclosure">()</span><span class="python_operator">
</span></pre>
    </div>
<p>The <code>func</code> keyword generates SQL functions, and the <code>subquery()</code> method on <code>Query</code> produces a SQL expression construct representing a SELECT statement embedded within an alias (it's actually shorthand for <code>query.statement.alias()</code>).
</p>
<p>Once we have our statement, it behaves like a <code>Table</code> construct, such as the one we created for <code>users</code> at the start of this tutorial.  The columns on the statement are accessible through an attribute called <code>c</code>:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_33', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">u</span><span class="python_operator">, </span><span class="python_name">count </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">stmt</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">address_count</span><span class="python_enclosure">)</span><span class="python_operator">.\
...     </span><span class="python_name">outerjoin</span><span class="python_enclosure">((</span><span class="python_name">stmt</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_operator">==</span><span class="python_name">stmt</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">order_by</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_enclosure">)</span><span class="python_operator">: 
...     </span><span class="python_keyword">print </span><span class="python_name">u</span><span class="python_operator">, </span><span class="python_name">count</span><span class="python_operator"></span></pre><div id="popbox_33_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, <br/>
users.fullname AS users_fullname, users.password AS users_password, <br/>
anon_1.address_count AS anon_1_address_count <br/>
FROM users LEFT OUTER JOIN (SELECT addresses.user_id AS user_id, count(?) AS address_count <br/>
FROM addresses GROUP BY addresses.user_id) AS anon_1 ON users.id = anon_1.user_id <br/>
ORDER BY users.id<br/>
['*']</div><pre><span class="python_operator">&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'ed'</span><span class="python_operator">,</span><span class="python_literal">'Ed Jones'</span><span class="python_operator">, </span><span class="python_literal">'f8s7ccs'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; </span><span class="python_name">None</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_operator">,</span><span class="python_literal">'Wendy Williams'</span><span class="python_operator">, </span><span class="python_literal">'foobar'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; </span><span class="python_name">None</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'mary'</span><span class="python_operator">,</span><span class="python_literal">'Mary Contrary'</span><span class="python_operator">, </span><span class="python_literal">'xxg527'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; </span><span class="python_name">None</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_operator">,</span><span class="python_literal">'Fred Flinstone'</span><span class="python_operator">, </span><span class="python_literal">'blah'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; </span><span class="python_name">None</span><span class="python_operator">
&lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jack'</span><span class="python_operator">,</span><span class="python_literal">'Jack Bean'</span><span class="python_operator">, </span><span class="python_literal">'gjffdd'</span><span class="python_enclosure">)</span><span class="python_operator">&gt; </span><span class="python_number">2</span><span class="python_operator">
</span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_joins_using"></a>
    
    <div class="sectionL3">

    <h3>Using EXISTS</h3>
    
    

<p>The EXISTS keyword in SQL is a boolean operator which returns True if the given expression contains any rows.  It may be used in many scenarios in place of joins, and is also useful for locating rows which do not have a corresponding row in a related table.
</p>
<p>There is an explicit EXISTS construct, which looks like this:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">sql </span><span class="python_keyword">import </span><span class="python_name">exists</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">stmt </span><span class="python_operator">= </span><span class="python_name">exists</span><span class="python_enclosure">()</span><span class="python_operator">.</span><span class="python_name">where</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">==</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_34', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">stmt</span><span class="python_enclosure">)</span><span class="python_operator">:   
...     </span><span class="python_keyword">print </span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_34_div" class="codepop" style="display:none;">SELECT users.name AS users_name <br/>
FROM users <br/>
WHERE EXISTS (SELECT * <br/>
FROM addresses <br/>
WHERE addresses.user_id = users.id)<br/>
[]</div><pre><span class="python_name">jack</span><span class="python_operator">
</span></pre>
    </div>
<p>The <code>Query</code> features several operators which make usage of EXISTS automatically.  Above, the statement can be expressed along the <code>User.addresses</code> relation using <code>any()</code>:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_35', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">any</span><span class="python_enclosure">())</span><span class="python_operator">:   
...     </span><span class="python_keyword">print </span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_35_div" class="codepop" style="display:none;">SELECT users.name AS users_name <br/>
FROM users <br/>
WHERE EXISTS (SELECT 1 <br/>
FROM addresses <br/>
WHERE users.id = addresses.user_id)<br/>
[]</div><pre><span class="python_name">jack</span><span class="python_operator">
</span></pre>
    </div>
<p><code>any()</code> takes criterion as well, to limit the rows matched:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_36', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">for </span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">any</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">.</span><span class="python_name">like</span><span class="python_enclosure">(</span><span class="python_literal">'%google%'</span><span class="python_enclosure">)))</span><span class="python_operator">:   
...     </span><span class="python_keyword">print </span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_36_div" class="codepop" style="display:none;">SELECT users.name AS users_name <br/>
FROM users <br/>
WHERE EXISTS (SELECT 1 <br/>
FROM addresses <br/>
WHERE users.id = addresses.user_id AND addresses.email_address LIKE ?)<br/>
['%google%']</div><pre><span class="python_name">jack</span><span class="python_operator">
</span></pre>
    </div>
<p><code>has()</code> is the same operator as <code>any()</code> for many-to-one relations (note the <code>~</code> operator here too, which means "NOT"):
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_37', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_operator">~</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">has</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">==</span><span class="python_literal">'jack'</span><span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"> </span></pre><div id="popbox_37_div" class="codepop" style="display:none;">SELECT addresses.id AS addresses_id, addresses.email_address AS addresses_email_address, <br/>
addresses.user_id AS addresses_user_id <br/>
FROM addresses <br/>
WHERE NOT (EXISTS (SELECT 1 <br/>
FROM users <br/>
WHERE users.id = addresses.user_id AND users.name = ?))<br/>
['jack']</div><pre><span class="python_enclosure">[]</span><span class="python_operator">
</span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_joins_relationop"></a>
    
    <div class="sectionL3">

    <h3>Common Relation Operators</h3>
    
    

<p>Here's all the operators which build on relations:
</p>
<ul>
 <li><p>equals (used for many-to-one)
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_operator">== </span><span class="python_name">someuser</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>not equals (used for many-to-one)
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_operator">!= </span><span class="python_name">someuser</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>IS NULL (used for many-to-one)
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_operator">== </span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>contains (used for one-to-many and many-to-many collections)
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">contains</span><span class="python_enclosure">(</span><span class="python_name">someaddress</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>any (used for one-to-many and many-to-many collections)
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">any</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">email_address </span><span class="python_operator">== </span><span class="python_literal">'bar'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># also takes keyword arguments:
</span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">any</span><span class="python_enclosure">(</span><span class="python_name">email_address</span><span class="python_operator">=</span><span class="python_literal">'bar'</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>has (used for many-to-one)
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">has</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'ed'</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>

 </li>

 <li><p>with_parent (used for any relation)
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">with_parent</span><span class="python_enclosure">(</span><span class="python_name">someuser</span><span class="python_operator">, </span><span class="python_literal">'addresses'</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>

 </li>
</ul>



            <a href="#top" class="totoc">back to section top</a>
    </div>




    </div>



    
    <A name="datamapping_deleting"></a>
    
    <div class="sectionL2">

    <h3>Deleting</h3>
    
    

<p>Let's try to delete <code>jack</code> and see how that goes.  We'll mark as deleted in the session, then we'll issue a <code>count</code> query to see that no rows remain:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">delete</span><span class="python_enclosure">(</span><span class="python_name">jack</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_38', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'jack'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">()</span><span class="python_operator"> </span></pre><div id="popbox_38_div" class="codepop" style="display:none;">UPDATE addresses SET user_id=? WHERE addresses.id = ?<br/>
[None, 1]<br/>
UPDATE addresses SET user_id=? WHERE addresses.id = ?<br/>
[None, 2]<br/>
DELETE FROM users WHERE users.id = ?<br/>
[5]<br/>
SELECT count(1) AS count_1 <br/>
FROM users <br/>
WHERE users.name = ?<br/>
['jack']</div><pre><span class="python_number">0</span><span class="python_operator">
</span></pre>
    </div>
<p>So far, so good.  How about Jack's <code>Address</code> objects ?
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_39', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span>
<span class="python_operator">...     </span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">.</span><span class="python_name">in_</span><span class="python_enclosure">([</span><span class="python_literal">'jack@google.com'</span><span class="python_operator">, </span><span class="python_literal">'j25@yahoo.com'</span><span class="python_enclosure">])</span>
<span class="python_operator">...  </span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">()</span><span class="python_operator"> </span></pre><div id="popbox_39_div" class="codepop" style="display:none;">SELECT count(1) AS count_1<br/>
FROM addresses <br/>
WHERE addresses.email_address IN (?, ?)<br/>
['jack@google.com', 'j25@yahoo.com']</div><pre><span class="python_number">2</span><span class="python_operator">
</span></pre>
    </div>
<p>Uh oh, they're still there !  Analyzing the flush SQL, we can see that the <code>user_id</code> column of each address was set to NULL, but the rows weren't deleted.  SQLAlchemy doesn't assume that deletes cascade, you have to tell it to do so.
</p>


    
    <A name="datamapping_deleting_cascade"></a>
    
    <div class="sectionL3">

    <h3>Configuring delete/delete-orphan Cascade</h3>
    
    

<p>We will configure <strong>cascade</strong> options on the <code>User.addresses</code> relation to change the behavior.  While SQLAlchemy allows you to add new attributes and relations to mappings at any point in time, in this case the existing relation needs to be removed, so we need to tear down the mappings completely and start again.  This is not a typical operation and is here just for illustrative purposes.
</p>
<p>Removing all ORM state is as follows:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">close</span><span class="python_enclosure">()  </span><span class="python_comment"># roll back and close the transaction</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">orm </span><span class="python_keyword">import </span><span class="python_name">clear_mappers</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">clear_mappers</span><span class="python_enclosure">() </span><span class="python_comment"># clear mappers</span><span class="python_operator">
</span></pre>
    </div>
<p>Below, we use <code>mapper()</code> to reconfigure an ORM mapping for <code>User</code> and <code>Address</code>, on our existing but currently un-mapped classes.  The <code>User.addresses</code> relation now has <code>delete, delete-orphan</code> cascade on it, which indicates that DELETE operations will cascade to attached <code>Address</code> objects as well as <code>Address</code> objects which are removed from their parent:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{    </span>
<span class="python_operator">...     </span><span class="python_literal">'addresses'</span><span class="python_operator">:</span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">'user'</span><span class="python_operator">, </span><span class="python_name">cascade</span><span class="python_operator">=</span><span class="python_literal">"all, delete, delete-orphan"</span><span class="python_enclosure">)</span>
<span class="python_operator">... </span><span class="python_enclosure">})</span><span class="python_operator">
&lt;</span><span class="python_name">Mapper at </span><span class="python_number">0x</span><span class="python_operator">...; </span><span class="python_name">User</span><span class="python_operator">&gt;
</span>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">addresses_table </span><span class="python_operator">= </span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">__table__</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses_table</span><span class="python_enclosure">) </span><span class="python_operator">
&lt;</span><span class="python_name">Mapper at </span><span class="python_number">0x</span><span class="python_operator">...; </span><span class="python_name">Address</span><span class="python_operator">&gt;
</span></pre>
    </div>
<p>Now when we load Jack (below using <code>get()</code>, which loads by primary key), removing an address from his <code>addresses</code> collection will result in that <code>Address</code> being deleted:
</p>

    

    <div class="code">
        <pre>
<span class="python_comment"># load Jack by primary key
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_40', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">jack </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get</span><span class="python_enclosure">(</span><span class="python_number">5</span><span class="python_enclosure">)</span><span class="python_operator">    </span></pre><div id="popbox_40_div" class="codepop" style="display:none;">BEGIN<br/>
SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.id = ?<br/>
[5]</div><pre>

<span class="python_comment"># remove one Address (lazy load fires off)
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_41', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_keyword">del </span><span class="python_name">jack</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">[</span><span class="python_number">1</span><span class="python_enclosure">]</span><span class="python_operator">  </span></pre><div id="popbox_41_div" class="codepop" style="display:none;">SELECT addresses.id AS addresses_id, addresses.email_address AS addresses_email_address, addresses.user_id AS addresses_user_id <br/>
FROM addresses <br/>
WHERE ? = addresses.user_id<br/>
[5]</div><pre>

<span class="python_comment"># only one address remains
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_42', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span>
<span class="python_operator">...     </span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">.</span><span class="python_name">in_</span><span class="python_enclosure">([</span><span class="python_literal">'jack@google.com'</span><span class="python_operator">, </span><span class="python_literal">'j25@yahoo.com'</span><span class="python_enclosure">])</span>
<span class="python_operator">... </span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">()</span><span class="python_operator"> </span></pre><div id="popbox_42_div" class="codepop" style="display:none;">DELETE FROM addresses WHERE addresses.id = ?<br/>
[2]<br/>
SELECT count(1) AS count_1<br/>
FROM addresses <br/>
WHERE addresses.email_address IN (?, ?)<br/>
['jack@google.com', 'j25@yahoo.com']</div><pre><span class="python_number">1</span><span class="python_operator">
</span></pre>
    </div>
<p>Deleting Jack will delete both Jack and his remaining <code>Address</code>:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">delete</span><span class="python_enclosure">(</span><span class="python_name">jack</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_43', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'jack'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">()</span><span class="python_operator"> </span></pre><div id="popbox_43_div" class="codepop" style="display:none;">DELETE FROM addresses WHERE addresses.id = ?<br/>
[1]<br/>
DELETE FROM users WHERE users.id = ?<br/>
[5]<br/>
SELECT count(1) AS count_1<br/>
FROM users <br/>
WHERE users.name = ?<br/>
['jack']</div><pre><span class="python_number">0</span><span class="python_operator">
</span>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_44', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span>
<span class="python_operator">...    </span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">.</span><span class="python_name">in_</span><span class="python_enclosure">([</span><span class="python_literal">'jack@google.com'</span><span class="python_operator">, </span><span class="python_literal">'j25@yahoo.com'</span><span class="python_enclosure">])</span>
<span class="python_operator">... </span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">()</span><span class="python_operator"> </span></pre><div id="popbox_44_div" class="codepop" style="display:none;">SELECT count(1) AS count_1<br/>
FROM addresses <br/>
WHERE addresses.email_address IN (?, ?)<br/>
['jack@google.com', 'j25@yahoo.com']</div><pre><span class="python_number">0</span><span class="python_operator">
</span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>




    </div>



    
    <A name="datamapping_manytomany"></a>
    
    <div class="sectionL2">

    <h3>Building a Many To Many Relation</h3>
    
    

<p>We're moving into the bonus round here, but lets show off a many-to-many relationship.  We'll sneak in some other features too, just to take a tour.  We'll make our application a blog application, where users can write <code>BlogPost</code>s, which have <code>Keywords</code> associated with them.
</p>
<p>The declarative setup is as follows:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_name">Text</span><span class="python_operator">
</span>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_comment"># association table</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">post_keywords </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'post_keywords'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
<span class="python_operator">...     </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'post_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">'posts.id'</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
<span class="python_operator">...     </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">'keywords.id'</span><span class="python_enclosure">))</span>
<span class="python_operator">... </span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">class </span><span class="python_name">BlogPost</span><span class="python_enclosure">(</span><span class="python_name">Base</span><span class="python_enclosure">)</span><span class="python_operator">:
...     </span><span class="python_name">__tablename__ </span><span class="python_operator">= </span><span class="python_literal">'posts'</span><span class="python_operator">
...
...     </span><span class="python_name">id </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
...     </span><span class="python_name">user_id </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">'users.id'</span><span class="python_enclosure">))</span><span class="python_operator">
...     </span><span class="python_name">headline </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">255</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">nullable</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">
...     </span><span class="python_name">body </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">Text</span><span class="python_enclosure">)</span><span class="python_operator">
...
...     </span><span class="python_comment"># many to many BlogPost&lt;-&gt;Keyword</span><span class="python_operator">
...     </span><span class="python_name">keywords </span><span class="python_operator">= </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_literal">'Keyword'</span><span class="python_operator">, </span><span class="python_name">secondary</span><span class="python_operator">=</span><span class="python_name">post_keywords</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">'posts'</span><span class="python_enclosure">)</span><span class="python_operator">
...
...     </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">headline</span><span class="python_operator">, </span><span class="python_name">body</span><span class="python_operator">, </span><span class="python_name">author</span><span class="python_enclosure">)</span><span class="python_operator">:
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">author </span><span class="python_operator">= </span><span class="python_name">author</span><span class="python_operator">
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">headline </span><span class="python_operator">= </span><span class="python_name">headline</span><span class="python_operator">
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">body </span><span class="python_operator">= </span><span class="python_name">body</span><span class="python_operator">
...
...     </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
...         </span><span class="python_keyword">return </span><span class="python_literal">"BlogPost(%r, %r, %r)" </span><span class="python_operator">% </span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">headline</span><span class="python_operator">, </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">body</span><span class="python_operator">, </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">author</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">class </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_name">Base</span><span class="python_enclosure">)</span><span class="python_operator">:
...     </span><span class="python_name">__tablename__ </span><span class="python_operator">= </span><span class="python_literal">'keywords'</span><span class="python_operator">
...
...     </span><span class="python_name">id </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
...     </span><span class="python_name">keyword </span><span class="python_operator">= </span><span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">50</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">nullable</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_operator">, </span><span class="python_name">unique</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
...
...     </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">keyword</span><span class="python_enclosure">)</span><span class="python_operator">:
...         </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">keyword </span><span class="python_operator">= </span><span class="python_name">keyword</span><span class="python_operator">
</span></pre>
    </div>
<p>Above, the many-to-many relation above is <code>BlogPost.keywords</code>.  The defining feature of a many to many relation is the <code>secondary</code> keyword argument which references a <code>Table</code> object representing the association table.  This table only contains columns which reference the two sides of the relation; if it has <em>any</em> other columns, such as its own primary key, or foreign keys to other tables, SQLAlchemy requires a different usage pattern called the "association object", described at <a href="mappers.html#advdatamapping_relation_patterns_association">Association Object</a>.
</p>
<p>The many-to-many relation is also bi-directional using the <code>backref</code> keyword.  This is the one case where usage of <code>backref</code> is generally required, since if a separate <code>posts</code> relation were added to the <code>Keyword</code> entity, both relations would independently add and remove rows from the <code>post_keywords</code> table and produce conflicts.
</p>
<p>We would also like our <code>BlogPost</code> class to have an <code>author</code> field.  We will add this as another bidirectional relationship, except one issue we'll have is that a single user might have lots of blog posts.  When we access <code>User.posts</code>, we'd like to be able to filter results further so as not to load the entire collection.  For this we use a setting accepted by <code>relation()</code> called <code>lazy='dynamic'</code>, which configures an alternate <strong>loader strategy</strong> on the attribute.  To use it on the "reverse" side of a <code>relation()</code>, we use the <code>backref()</code> function:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_keyword">from </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">orm </span><span class="python_keyword">import </span><span class="python_name">backref</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_comment"># "dynamic" loading relation to User</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">BlogPost</span><span class="python_operator">.</span><span class="python_name">author </span><span class="python_operator">= </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_name">backref</span><span class="python_enclosure">(</span><span class="python_literal">'posts'</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_literal">'dynamic'</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>
<p>Create new tables:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_45', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">metadata</span><span class="python_operator">.</span><span class="python_name">create_all</span><span class="python_enclosure">(</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator"> </span></pre><div id="popbox_45_div" class="codepop" style="display:none;">PRAGMA table_info(&quot;users&quot;)<br/>
{}<br/>
PRAGMA table_info(&quot;addresses&quot;)<br/>
{}<br/>
PRAGMA table_info(&quot;posts&quot;)<br/>
{}<br/>
PRAGMA table_info(&quot;keywords&quot;)<br/>
{}<br/>
PRAGMA table_info(&quot;post_keywords&quot;)<br/>
{}<br/>
CREATE TABLE posts (<br/>
    id INTEGER NOT NULL, <br/>
    user_id INTEGER, <br/>
    headline VARCHAR(255) NOT NULL, <br/>
    body TEXT, <br/>
    PRIMARY KEY (id), <br/>
     FOREIGN KEY(user_id) REFERENCES users (id)<br/>
)<br/>
{}<br/>
COMMIT<br/>
CREATE TABLE keywords (<br/>
    id INTEGER NOT NULL, <br/>
    keyword VARCHAR(50) NOT NULL, <br/>
    PRIMARY KEY (id), <br/>
     UNIQUE (keyword)<br/>
)<br/>
{}<br/>
COMMIT<br/>
CREATE TABLE post_keywords (<br/>
    post_id INTEGER, <br/>
    keyword_id INTEGER, <br/>
     FOREIGN KEY(post_id) REFERENCES posts (id), <br/>
     FOREIGN KEY(keyword_id) REFERENCES keywords (id)<br/>
)<br/>
{}<br/>
COMMIT</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Usage is not too different from what we've been doing.  Let's give Wendy some blog posts:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_46', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">wendy </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'wendy'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_46_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.name = ? <br/>
 LIMIT 2 OFFSET 0<br/>
['wendy']</div><pre><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">post </span><span class="python_operator">= </span><span class="python_name">BlogPost</span><span class="python_enclosure">(</span><span class="python_literal">"Wendy's Blog Post"</span><span class="python_operator">, </span><span class="python_literal">"This is a test"</span><span class="python_operator">, </span><span class="python_name">wendy</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">add</span><span class="python_enclosure">(</span><span class="python_name">post</span><span class="python_enclosure">)</span><span class="python_operator">
</span></pre>
    </div>
<p>We're storing keywords uniquely in the database, but we know that we don't have any yet, so we can just create them:
</p>

    

    <div class="sliding_code">
        <pre>
<span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">post</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_literal">&gt;&gt;&gt; </span><span class="python_name">post</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'firstpost'</span><span class="python_enclosure">))</span><span class="python_operator">
</span></pre>
    </div>
<p>We can now look up all blog posts with the keyword 'firstpost'.   We'll use the <code>any</code> operator to locate "blog posts where any of its keywords has the keyword string 'firstpost'":
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_47', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">BlogPost</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">BlogPost</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">any</span><span class="python_enclosure">(</span><span class="python_name">keyword</span><span class="python_operator">=</span><span class="python_literal">'firstpost'</span><span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_47_div" class="codepop" style="display:none;">INSERT INTO posts (user_id, headline, body) VALUES (?, ?, ?)<br/>
[2, &quot;Wendy's Blog Post&quot;, 'This is a test']<br/>
INSERT INTO keywords (keyword) VALUES (?)<br/>
['wendy']<br/>
INSERT INTO keywords (keyword) VALUES (?)<br/>
['firstpost']<br/>
INSERT INTO post_keywords (post_id, keyword_id) VALUES (?, ?)<br/>
[[1, 1], [1, 2]]<br/>
SELECT posts.id AS posts_id, posts.user_id AS posts_user_id, posts.headline AS posts_headline, posts.body AS posts_body <br/>
FROM posts <br/>
WHERE EXISTS (SELECT 1 <br/>
FROM post_keywords, keywords <br/>
WHERE posts.id = post_keywords.post_id AND keywords.id = post_keywords.keyword_id AND keywords.keyword = ?)<br/>
['firstpost']</div><pre><span class="python_enclosure">[</span><span class="python_name">BlogPost</span><span class="python_enclosure">(</span><span class="python_literal">"Wendy's Blog Post"</span><span class="python_operator">, </span><span class="python_literal">'This is a test'</span><span class="python_operator">, &lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_operator">,</span><span class="python_literal">'Wendy Williams'</span><span class="python_operator">, </span><span class="python_literal">'foobar'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">)]</span><span class="python_operator">
</span></pre>
    </div>
<p>If we want to look up just Wendy's posts, we can tell the query to narrow down to her as a parent:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_48', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">BlogPost</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">BlogPost</span><span class="python_operator">.</span><span class="python_name">author</span><span class="python_operator">==</span><span class="python_name">wendy</span><span class="python_enclosure">)</span><span class="python_operator">.\
... </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">BlogPost</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">any</span><span class="python_enclosure">(</span><span class="python_name">keyword</span><span class="python_operator">=</span><span class="python_literal">'firstpost'</span><span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_48_div" class="codepop" style="display:none;">SELECT posts.id AS posts_id, posts.user_id AS posts_user_id, posts.headline AS posts_headline, posts.body AS posts_body <br/>
FROM posts <br/>
WHERE ? = posts.user_id AND (EXISTS (SELECT 1 <br/>
FROM post_keywords, keywords <br/>
WHERE posts.id = post_keywords.post_id AND keywords.id = post_keywords.keyword_id AND keywords.keyword = ?))<br/>
[2, 'firstpost']</div><pre><span class="python_enclosure">[</span><span class="python_name">BlogPost</span><span class="python_enclosure">(</span><span class="python_literal">"Wendy's Blog Post"</span><span class="python_operator">, </span><span class="python_literal">'This is a test'</span><span class="python_operator">, &lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_operator">,</span><span class="python_literal">'Wendy Williams'</span><span class="python_operator">, </span><span class="python_literal">'foobar'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">)]</span><span class="python_operator">
</span></pre>
    </div>
<p>Or we can use Wendy's own <code>posts</code> relation, which is a "dynamic" relation, to query straight from there:
</p>

    

    <div class="code">
        <pre>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_49', 'show', 'hide')" class="codepoplink">sql</a>&gt;&gt;&gt; </span><span class="python_name">wendy</span><span class="python_operator">.</span><span class="python_name">posts</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">BlogPost</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">any</span><span class="python_enclosure">(</span><span class="python_name">keyword</span><span class="python_operator">=</span><span class="python_literal">'firstpost'</span><span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_49_div" class="codepop" style="display:none;">SELECT posts.id AS posts_id, posts.user_id AS posts_user_id, posts.headline AS posts_headline, posts.body AS posts_body <br/>
FROM posts <br/>
WHERE ? = posts.user_id AND (EXISTS (SELECT 1 <br/>
FROM post_keywords, keywords <br/>
WHERE posts.id = post_keywords.post_id AND keywords.id = post_keywords.keyword_id AND keywords.keyword = ?))<br/>
[2, 'firstpost']</div><pre><span class="python_enclosure">[</span><span class="python_name">BlogPost</span><span class="python_enclosure">(</span><span class="python_literal">"Wendy's Blog Post"</span><span class="python_operator">, </span><span class="python_literal">'This is a test'</span><span class="python_operator">, &lt;</span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'wendy'</span><span class="python_operator">,</span><span class="python_literal">'Wendy Williams'</span><span class="python_operator">, </span><span class="python_literal">'foobar'</span><span class="python_enclosure">)</span><span class="python_operator">&gt;</span><span class="python_enclosure">)]</span><span class="python_operator">
</span></pre>
    </div>



            <a href="#top" class="totoc">back to section top</a>
    </div>



    
    <A name="datamapping_further"></a>
    
    <div class="sectionL2">

    <h3>Further Reference</h3>
    
    

<p>Generated Documentation for Query: <a href="sqlalchemy_orm_query.html#docstrings_sqlalchemy.orm.query_Query">class Query(object)</a>
</p>
<p>ORM Generated Docs: <a href="sqlalchemy_orm.html#docstrings_sqlalchemy.orm">module sqlalchemy.orm</a>
</p>
<p>Further information on mapping setups are in <a href="mappers.html">Mapper Configuration</a>.
</p>
<p>Further information on working with Sessions: <a href="session.html">Using the Session</a>.
</p>




            <a href="#top" class="totoc">back to section top</a>
    </div>




    </div>





    <div class="bottomnav">
        
    <div class="prevnext">

            
            Previous: <a href="intro.html">Overview / Installation</a>

               |   
            Next: <a href="sqlexpression.html">SQL Expression Language Tutorial</a>
    </div>

    </div>






</body>
</html>






